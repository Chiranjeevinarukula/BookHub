{% extends 'base.html' %}
{% load stars %}

{% block content %}

<div class="row">
  <div class="col-lg-3">
      <div class="sticky-top">
        <div class="card" style="max-width: 18rem;">
          <img class="card-img-top" src="{{ book.cover_image.url }}" alt="Card image cap">
          <div class="card-body">
            <p class="card-text">
                <div class="rows">{{ book.get_rating_values|barchart }}</div>
                <h1>{{book.title}}</h1>
                <h5>{{book.author}}</h5></p>
          </div>
        </div>
      </div>
  </div>
  <div class="col-lg-9">
    {{ book.get_rating_values|stars }}
    <div>
      <form action="{% url 'createrating' bookId=book.id %}" method="post">
          {% csrf_token %}
          <div class="rating mr-auto">
              <input type="radio" id="star5" name="rating" {% if book.rating.first.rating == 5 %}checked{% endif %} value="5" />
              <label class="star" for="star5" title="Awesome" aria-hidden="true"></label>
              <input type="radio" id="star4" name="rating"  {% if book.rating.first.rating == 4 %}checked{% endif %} value="4" />
              <label class="star" for="star4" title="Great" aria-hidden="true"></label>
              <input type="radio" id="star3" name="rating" value="3"  {% if book.rating.first.rating == 3 %}checked{% endif %}/>
              <label class="star" for="star3" title="Very good" aria-hidden="true"></label>
              <input type="radio" id="star2" name="rating" value="2"  {% if book.rating.first.rating == 2 %}checked{% endif %}/>
              <label class="star" for="star2" title="Good" aria-hidden="true"></label>
              <input type="radio" id="star1" name="rating" value="1"  {% if book.rating.first.rating == 1 %}checked{% endif %}/>
              <label class="star" for="star1" title="Bad" aria-hidden="true"></label>
            </div>
            <input type="submit" value="Submit">
      </form>
    </div>
    <form action="{% url 'createreview' bookId=book.id %}" method="post">
      {% csrf_token %}
      
      <label for="message">Enter your Review:</label><br>
      <textarea class="form-control" id="message" name="review" rows="4" cols="50" value="{{review_form.review}}" required></textarea><br>
      
      <!-- Submit Button -->
      <input type="submit" value="Submit">
  </form>

  {% for review in book.review.all %}
  <div class="comments-container">
    <div class="comment">
        <div class="comment-text">
            <a href="">
                <div style="cursor: pointer; color: blue; text-decoration: underline;">
                    {% if review.reviewedUser.profile.profile_pic %}
                        <img class="user-profile" src="{{review.reviewedUser.profile.profile_pic.url}}" alt="User Avatar">
                    {% else %}
                        <div class="user-profile"></div>
                    {% endif %}
                    <span class="user-name">{{review.reviewedUser}}:</span> 
                </div>
            </a>
            {{review.review}}
            {{ book.rating.first.rating | rating }}
            <div class="reply-button">Reply</div>
            <div class="load-replies-button" data-review-id="{{review.id}}">Load Replies</div>
            <div class="replies"></div>
            <div class="reply-form" style="display: none;">
              {{user.username}}
                <form>
                    <input type="hidden" id="user-name" name="repliedUser" value="{{ user.id }}">
                    <input type="hidden" id="user-comment" name="review" value="{{ review.id }}">
                    <textarea class="reply-form-textarea" name="reply" placeholder="Your reply">{{ review.reviewreply }}</textarea>
                    {% if user.is_authenticated %} 
                        <button class="submit-reply">Submit</button>
                    {% else %}
                    You are not logged in.<a href="{% url 'login' %}">Login</a> By link
                    {% endif %}
                </form>
            </div>
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
</div>

{% endblock %}

{% block js %}
  <script>
    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Check if this cookie is the one we're looking for
            if (cookie.substring(0, name.length + 1) === name + '=') {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
      }
      return cookieValue;
    }

      $(document).ready(function() {
      // Load Replies Button Click
      $(".load-replies-button").click(function() {
        console.log('called')
          const repliesContainer = $(this).siblings(".replies");
          const reviewId = $(this).data("review-id");
          console.log(reviewId)
          // Send an AJAX request to fetch replies
          $.ajax({
              url: `/books/review/${reviewId}/getreplies`, // Replace with your actual endpoint
              type: "GET",
              dataType: "json",
              success: function(data) {
                  // Clear existing replies
                  repliesContainer.empty();
                  console.log(data)
                  // Iterate through the fetched replies and append them to the container
                  $.each(data, function(index, reply) {
                    console.log(reply.repliedUser.profile)
                      const replyElement = `
                          <div class="sample-reply">
                              <span class="user-name">${reply.repliedUser}:</span> ${reply.reply}
                          </div>`;
                      repliesContainer.append(replyElement);
                  });
                  if(data.length==0){
                    const replyElement = `
                          <div class="sample-reply">
                              <span class="user-name">No replies</span>
                          </div>`;
                      repliesContainer.append(replyElement);
                  }
                  // Show the replies container
                  repliesContainer.show();
              },
              error: function(error) {
                  console.error("An error occurred:", error);
                      repliesContainer.append(replyElement);
              }
          });
      });

      $(".reply-button").click(function() {
          const replyForm = $(this).siblings(".reply-form");
          replyForm.toggle(); // Toggle the visibility of the reply form
      });
  
      // Submit Reply Button Click (You can adapt this part to your specific form)
      $(".submit-reply").click(function(e) {
          e.preventDefault(); // Prevent the default form submission
  
          const replyForm = $(this).closest("form");
          const formData = replyForm.serialize(); // Serialize form data
          // Send an AJAX request to submit the reply 
          $.ajax({
              url: "/books/review/reply/", // Replace with your actual endpoint
              type: "POST",
              data: formData,
              dataType: "json",
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')  // Include the CSRF token
              },
              success: function(response) {
                  // Handle the response (e.g., display a success message)
                  console.log("Reply submitted successfully:", response);
                  replyForm.toggle();
                  // You may also clear the form or update the replies section
              },
              error: function(error) {
                  console.error("An error occurred:", error);
              }
          });
          
      });
  });
  </script>
{% endblock %}